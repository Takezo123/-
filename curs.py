from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import Message
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode, ContentType
from aiogram.utils.keyboard import ReplyKeyboardBuilder
import asyncio
from openai import OpenAI
import logging
import re

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

API_TOKEN = '7786110568:AAGAcufBSEGiX5WDYwhBksEe-b0rw7xuwi0'

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ OpenRouter
base_url = "https://openrouter.ai/api/v1"
api_key = "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"  # –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ô –ö–õ–Æ–ß

api = OpenAI(
    api_key=api_key,
    base_url=base_url,
    default_headers={
        "HTTP-Referer": "Noginsk College Bot",
        "X-Title": "Admissions Assistant"
    }
)

bot = Bot(token=API_TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
dp = Dispatcher()

# –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_states = {}
# –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
conversation_history = {}

# –û—Ç–≤–µ—Ç—ã –Ω–∞ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã (–¥–ª—è –ò–ò)
faq_responses = {
    "–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –∫–æ–ª–ª–µ–¥–∂–∞":
        "–û—á–Ω–æ–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ (–±—é–¥–∂–µ—Ç):\n"
        "1. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –∏ —Ä–µ–º–æ–Ω—Ç –∞–≤—Ç–æ—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ (23.02.07, –ù–æ–≥–∏–Ω—Å–∫, 3–≥.10–º.) - 50 –º–µ—Å—Ç\n"
        "2. –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–≤–æ–∑–æ–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ (23.02.01, –ù–æ–≥–∏–Ω—Å–∫, 3–≥.10–º) - 50 –º–µ—Å—Ç\n"
        "3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–æ–º –ø—Ä–æ–¥—É–∫—Ü–∏–∏, –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ —É—Å–ª—É–≥ (27.02.07, –ù–æ–≥–∏–Ω—Å–∫, 2–≥.10–º) - 50 –º–µ—Å—Ç\n"
        "4. –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –ª–æ–≥–∏—Å—Ç–∏–∫–µ (38.02.03, –ë–∞–ª–∞—à–∏—Ö–∞, 2–≥.10–º.) - 25 –º–µ—Å—Ç\n"
        "5. –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –ª–æ–≥–∏—Å—Ç–∏–∫–µ (38.02.03, –ù–æ–≥–∏–Ω—Å–∫, 2–≥.10–º.) - 50 –º–µ—Å—Ç\n"
        "6. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ (09.02.07, –ù–æ–≥–∏–Ω—Å–∫, 3–≥.10–º.) - 50 –º–µ—Å—Ç\n"
        "7. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ (09.02.07, –ë–∞–ª–∞—à–∏—Ö–∞, 3–≥.10–º.) - 25 –º–µ—Å—Ç\n"
        "8. –°–µ—Ç–µ–≤–æ–µ –∏ —Å–∏—Å—Ç–µ–º–Ω–æ–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ (09.02.06, –ë–∞–ª–∞—à–∏—Ö–∞, 3–≥.10–º.) - 25 –º–µ—Å—Ç\n"
        "9. –°–µ—Ç–µ–≤–æ–µ –∏ —Å–∏—Å—Ç–µ–º–Ω–æ–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ (09.02.06, –ù–æ–≥–∏–Ω—Å–∫, 3–≥.10–º.) - 25 –º–µ—Å—Ç\n"
        "10. –¢—É—Ä–∏–∑–º –∏ –≥–æ—Å—Ç–µ–ø—Ä–∏–∏–º—Å—Ç–≤–æ (43.02.16, –ù–æ–≥–∏–Ω—Å–∫, 2–≥.10–º) - 50 –º–µ—Å—Ç\n"
        "11. –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏–Ω–¥—É—Å—Ç—Ä–∏–∏ –∫—Ä–∞—Å–æ—Ç—ã (43.02.17, –ë–∞–ª–∞—à–∏—Ö–∞, 2–≥.10–º.) - 25 –º–µ—Å—Ç\n"
        "12. –ü–æ–≤–∞—Ä—Å–∫–æ–µ –∏ –∫–æ–Ω–¥–∏—Ç–µ—Ä—Å–∫–æ–µ –¥–µ–ª–æ (43.02.15, –ù–æ–≥–∏–Ω—Å–∫, 3–≥.10–º.) - 50 –º–µ—Å—Ç\n\n"

        "–ü—Ä–æ—Ñ–µ—Å—Å–∏–∏ (–±—é–¥–∂–µ—Ç):\n"
        "1. –ú–∞—Å—Ç–µ—Ä —Å–ª–µ—Å–∞—Ä–Ω—ã—Ö —Ä–∞–±–æ—Ç (15.01.35, –ù–æ–≥–∏–Ω—Å–∫, 2–≥.2–º) - 50 –º–µ—Å—Ç\n"
        "2. –ú–∞—Å—Ç–µ—Ä —Å–ª–µ—Å–∞—Ä–Ω—ã—Ö —Ä–∞–±–æ—Ç (15.01.35, –ù–æ–≥–∏–Ω—Å–∫, 2–≥.10–º) - 25 –º–µ—Å—Ç\n"
        "3. –û–ø–µ—Ä–∞—Ç–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –∏ —Ä–µ—Å—É—Ä—Å–æ–≤ (09.01.03, –ù–æ–≥–∏–Ω—Å–∫, 1–≥.10–º) - 50 –º–µ—Å—Ç\n"
        "4. –û–ø–µ—Ä–∞—Ç–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –∏ —Ä–µ—Å—É—Ä—Å–æ–≤ (09.01.03, –ë–∞–ª–∞—à–∏—Ö–∞, 1–≥.10–º) - 25 –º–µ—Å—Ç\n\n"

        "–û—á–Ω–æ–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ (–≤–Ω–µ–±—é–¥–∂–µ—Ç):\n"
        "1. –Æ—Ä–∏—Å–ø—Ä—É–¥–µ–Ω—Ü–∏—è (40.02.04, –ù–æ–≥–∏–Ω—Å–∫, 2–≥.10–º.) - 50 –º–µ—Å—Ç\n"
        "2. –Æ—Ä–∏—Å–ø—Ä—É–¥–µ–Ω—Ü–∏—è (40.02.04, –ë–∞–ª–∞—à–∏—Ö–∞, 2–≥.10–º.) - 25 –º–µ—Å—Ç\n"
        "3. –ë–∞–Ω–∫–æ–≤—Å–∫–æ–µ –¥–µ–ª–æ (38.02.07, –ù–æ–≥–∏–Ω—Å–∫, 2–≥.10–º.) - 25 –º–µ—Å—Ç\n"
        "4. –ë–∞–Ω–∫–æ–≤—Å–∫–æ–µ –¥–µ–ª–æ (38.02.07, –ë–∞–ª–∞—à–∏—Ö–∞, 2–≥.10–º.) - 25 –º–µ—Å—Ç\n\n"

        "–ó–∞–æ—á–Ω–æ–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ (–≤–Ω–µ–±—é–¥–∂–µ—Ç):\n"
        "1. –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –ª–æ–≥–∏—Å—Ç–∏–∫–µ (38.02.03, –ù–æ–≥–∏–Ω—Å–∫, 2–≥.10–º., –Ω–∞ –±–∞–∑–µ 11 –∫–ª.) - 16 –º–µ—Å—Ç\n"
        "2. –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –ª–æ–≥–∏—Å—Ç–∏–∫–µ (38.02.03, –ù–æ–≥–∏–Ω—Å–∫, 3–≥.10–º., –Ω–∞ –±–∞–∑–µ 9 –∫–ª.) - 25 –º–µ—Å—Ç",

    "–ö–æ–Ω—Ç–∞–∫—Ç—ã –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏":
        "–¢–µ–ª–µ—Ñ–æ–Ω –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏: 8-916-084-38-73",

    "–ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏":
        "–†–∞–±–æ—á–∏–µ –¥–Ω–∏: –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ - –ø—è—Ç–Ω–∏—Ü–∞\n"
        "–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã: 9:00 - 16:00\n"
        "–ü–µ—Ä–∏–æ–¥ —Ä–∞–±–æ—Ç—ã: 20 –∏—é–Ω—è - 15 –∞–≤–≥—É—Å—Ç–∞ 2025 –≥.\n"
        "–ü–µ—Ä–µ—Ä—ã–≤: –±–µ–∑ –ø–µ—Ä–µ—Ä—ã–≤–∞ –Ω–∞ –æ–±–µ–¥",

    "–ö–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω—É–∂–Ω—ã?":
        "–û—Å–Ω–æ–≤–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:\n"
        "- –ö–æ–ø–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞\n"
        "- –û—Ä–∏–≥–∏–Ω–∞–ª –∏ –∫–æ–ø–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –æ–± –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–∏\n"
        "- 6 —Ñ–æ—Ç–æ 3—Ö4\n\n"
        "–ü–æ—Å–ª–µ –∑–∞—á–∏—Å–ª–µ–Ω–∏—è:\n"
        "- –ú–µ–¥—Å–ø—Ä–∞–≤–∫–∞ –ø–æ —Ñ–æ—Ä–º–µ 086/—É\n"
        "- –ö–æ–ø–∏—è –°–ù–ò–õ–°\n"
        "- –ö–æ–ø–∏—è –ò–ù–ù\n"
        "- –ö–æ–ø–∏—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –ø–æ–ª–∏—Å–∞",

    "–ü—Ä–æ—Ö–æ–¥–Ω—ã–µ –±–∞–ª–ª—ã":
        "–ö–æ–Ω–∫—É—Ä—Å –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è –ø–æ —Å—Ä–µ–¥–Ω–µ–º—É –±–∞–ª–ª—É –∞—Ç—Ç–µ—Å—Ç–∞—Ç–∞\n"
        "–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω\n\n"
        "–ë–æ–Ω—É—Å–Ω—ã–µ –±–∞–ª–ª—ã –∑–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:\n"
        "- –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –æ–ª–∏–º–ø–∏–∞–¥: +2 –±–∞–ª–ª–∞\n"
        "- –ü—Ä–∏–∑–µ—Ä—ã –∫–æ–Ω–∫—É—Ä—Å–æ–≤: +1.5 –±–∞–ª–ª–∞",

    "–ï—Å—Ç—å –ª–∏ –æ–±—â–µ–∂–∏—Ç–∏–µ?":
        "–°–≤–æ–±–æ–¥–Ω—ã—Ö –º–µ—Å—Ç –≤ –æ–±—â–µ–∂–∏—Ç–∏–∏ –∫–æ–ª–ª–µ–¥–∂–∞ –Ω–µ—Ç"
}

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å HTML)
formatted_faq_responses = {
    "–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –∫–æ–ª–ª–µ–¥–∂–∞":
        "<b>–û—á–Ω–æ–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ (–±—é–¥–∂–µ—Ç):</b>\n"
        "1. üîß <b>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –∏ —Ä–µ–º–æ–Ω—Ç –∞–≤—Ç–æ—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤</b>\n"
        "   - –ö–æ–¥: 23.02.07\n"
        "   - –ù–æ–≥–∏–Ω—Å–∫, 3–≥.10–º.\n"
        "   - <b>50 –º–µ—Å—Ç</b>\n\n"

        "2. üöö <b>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–≤–æ–∑–æ–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ</b>\n"
        "   - –ö–æ–¥: 23.02.01\n"
        "   - –ù–æ–≥–∏–Ω—Å–∫, 3–≥.10–º\n"
        "   - <b>50 –º–µ—Å—Ç</b>\n\n"

        "3. üìä <b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–æ–º –ø—Ä–æ–¥—É–∫—Ü–∏–∏, –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ —É—Å–ª—É–≥</b>\n"
        "   - –ö–æ–¥: 27.02.07\n"
        "   - –ù–æ–≥–∏–Ω—Å–∫, 2–≥.10–º\n"
        "   - <b>50 –º–µ—Å—Ç</b>\n\n"

        "4. üì¶ <b>–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –ª–æ–≥–∏—Å—Ç–∏–∫–µ</b>\n"
        "   - –ö–æ–¥: 38.02.03\n"
        "   - –ë–∞–ª–∞—à–∏—Ö–∞, 2–≥.10–º.\n"
        "   - <b>25 –º–µ—Å—Ç</b>\n\n"

        "5. üì¶ <b>–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –ª–æ–≥–∏—Å—Ç–∏–∫–µ</b>\n"
        "   - –ö–æ–¥: 38.02.03\n"
        "   - –ù–æ–≥–∏–Ω—Å–∫, 2–≥.10–º.\n"
        "   - <b>50 –º–µ—Å—Ç</b>\n\n"

        "6. üíª <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ</b>\n"
        "   - –ö–æ–¥: 09.02.07\n"
        "   - –ù–æ–≥–∏–Ω—Å–∫, 3–≥.10–º.\n"
        "   - <b>50 –º–µ—Å—Ç</b>\n\n"

        "7. üíª <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ</b>\n"
        "   - –ö–æ–¥: 09.02.07\n"
        "   - –ë–∞–ª–∞—à–∏—Ö–∞, 3–≥.10–º.\n"
        "   - <b>25 –º–µ—Å—Ç</b>\n\n"

        "8. üåê <b>–°–µ—Ç–µ–≤–æ–µ –∏ —Å–∏—Å—Ç–µ–º–Ω–æ–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</b>\n"
        "   - –ö–æ–¥: 09.02.06\n"
        "   - –ë–∞–ª–∞—à–∏—Ö–∞, 3–≥.10–º.\n"
        "   - <b>25 –º–µ—Å—Ç</b>\n\n"

        "9. üåê <b>–°–µ—Ç–µ–≤–æ–µ –∏ —Å–∏—Å—Ç–µ–º–Ω–æ–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</b>\n"
        "   - –ö–æ–¥: 09.02.06\n"
        "   - –ù–æ–≥–∏–Ω—Å–∫, 3–≥.10–º.\n"
        "   - <b>25 –º–µ—Å—Ç</b>\n\n"

        "10. ‚úàÔ∏è <b>–¢—É—Ä–∏–∑–º –∏ –≥–æ—Å—Ç–µ–ø—Ä–∏–∏–º—Å—Ç–≤–æ</b>\n"
        "    - –ö–æ–¥: 43.02.16\n"
        "    - –ù–æ–≥–∏–Ω—Å–∫, 2–≥.10–º\n"
        "    - <b>50 –º–µ—Å—Ç</b>\n\n"

        "11. üíÑ <b>–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏–Ω–¥—É—Å—Ç—Ä–∏–∏ –∫—Ä–∞—Å–æ—Ç—ã</b>\n"
        "    - –ö–æ–¥: 43.02.17\n"
        "    - –ë–∞–ª–∞—à–∏—Ö–∞, 2–≥.10–º.\n"
        "    - <b>25 –º–µ—Å—Ç</b>\n\n"

        "12. üë®‚Äçüç≥ <b>–ü–æ–≤–∞—Ä—Å–∫–æ–µ –∏ –∫–æ–Ω–¥–∏—Ç–µ—Ä—Å–∫–æ–µ –¥–µ–ª–æ</b>\n"
        "    - –ö–æ–¥: 43.02.15\n"
        "    - –ù–æ–≥–∏–Ω—Å–∫, 3–≥.10–º.\n"
        "    - <b>50 –º–µ—Å—Ç</b>\n\n"

        "<b>–ü—Ä–æ—Ñ–µ—Å—Å–∏–∏ (–±—é–¥–∂–µ—Ç):</b>\n"
        "1. üîß <b>–ú–∞—Å—Ç–µ—Ä —Å–ª–µ—Å–∞—Ä–Ω—ã—Ö —Ä–∞–±–æ—Ç</b>\n"
        "   - –ö–æ–¥: 15.01.35\n"
        "   - –ù–æ–≥–∏–Ω—Å–∫, 2–≥.2–º\n"
        "   - <b>50 –º–µ—Å—Ç</b>\n\n"

        "2. üîß <b>–ú–∞—Å—Ç–µ—Ä —Å–ª–µ—Å–∞—Ä–Ω—ã—Ö —Ä–∞–±–æ—Ç</b>\n"
        "   - –ö–æ–¥: 15.01.35\n"
        "   - –ù–æ–≥–∏–Ω—Å–∫, 2–≥.10–º\n"
        "   - <b>25 –º–µ—Å—Ç</b>\n\n"

        "3. üíª <b>–û–ø–µ—Ä–∞—Ç–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –∏ —Ä–µ—Å—É—Ä—Å–æ–≤</b>\n"
        "   - –ö–æ–¥: 09.01.03\n"
        "   - –ù–æ–≥–∏–Ω—Å–∫, 1–≥.10–º\n"
        "   - <b>50 –º–µ—Å—Ç</b>\n\n"

        "4. üíª <b>–û–ø–µ—Ä–∞—Ç–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –∏ —Ä–µ—Å—É—Ä—Å–æ–≤</b>\n"
        "   - –ö–æ–¥: 09.01.03\n"
        "   - –ë–∞–ª–∞—à–∏—Ö–∞, 1–≥.10–º\n"
        "   - <b>25 –º–µ—Å—Ç</b>\n\n"

        "<b>–û—á–Ω–æ–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ (–≤–Ω–µ–±—é–¥–∂–µ—Ç):</b>\n"
        "1. ‚öñÔ∏è <b>–Æ—Ä–∏—Å–ø—Ä—É–¥–µ–Ω—Ü–∏—è</b>\n"
        "   - –ö–æ–¥: 40.02.04\n"
        "   - –ù–æ–≥–∏–Ω—Å–∫, 2–≥.10–º.\n"
        "   - <b>50 –º–µ—Å—Ç</b>\n\n"

        "2. ‚öñÔ∏è <b>–Æ—Ä–∏—Å–ø—Ä—É–¥–µ–Ω—Ü–∏—è</b>\n"
        "   - –ö–æ–¥: 40.02.04\n"
        "   - –ë–∞–ª–∞—à–∏—Ö–∞, 2–≥.10–º.\n"
        "   - <b>25 –º–µ—Å—Ç</b>\n\n"

        "3. üí∞ <b>–ë–∞–Ω–∫–æ–≤—Å–∫–æ–µ –¥–µ–ª–æ</b>\n"
        "   - –ö–æ–¥: 38.02.07\n"
        "   - –ù–æ–≥–∏–Ω—Å–∫, 2–≥.10–º.\n"
        "   - <b>25 –º–µ—Å—Ç</b>\n\n"

        "4. üí∞ <b>–ë–∞–Ω–∫–æ–≤—Å–∫–æ–µ –¥–µ–ª–æ</b>\n"
        "   - –ö–æ–¥: 38.02.07\n"
        "   - –ë–∞–ª–∞—à–∏—Ö–∞, 2–≥.10–º.\n"
        "   - <b>25 –º–µ—Å—Ç</b>\n\n"

        "<b>–ó–∞–æ—á–Ω–æ–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ (–≤–Ω–µ–±—é–¥–∂–µ—Ç):</b>\n"
        "1. üì¶ <b>–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –ª–æ–≥–∏—Å—Ç–∏–∫–µ</b>\n"
        "   - –ö–æ–¥: 38.02.03\n"
        "   - –ù–æ–≥–∏–Ω—Å–∫, 2–≥.10–º.\n"
        "   - –ù–∞ –±–∞–∑–µ 11 –∫–ª.\n"
        "   - <b>16 –º–µ—Å—Ç</b>\n\n"

        "2. üì¶ <b>–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –ª–æ–≥–∏—Å—Ç–∏–∫–µ</b>\n"
        "   - –ö–æ–¥: 38.02.03\n"
        "   - –ù–æ–≥–∏–Ω—Å–∫, 3–≥.10–º.\n"
        "   - –ù–∞ –±–∞–∑–µ 9 –∫–ª.\n"
        "   - <b>25 –º–µ—Å—Ç</b>",

    "–ö–æ–Ω—Ç–∞–∫—Ç—ã –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏":
        "üìû <b>–¢–µ–ª–µ—Ñ–æ–Ω –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏:</b> 8-916-084-38-73",

    "–ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏":
        "üïí <b>–†–∞–±–æ—á–∏–µ –¥–Ω–∏:</b> –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ - –ø—è—Ç–Ω–∏—Ü–∞\n"
        "‚è∞ <b>–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã:</b> 9:00 - 16:00\n"
        "üìÖ <b>–ü–µ—Ä–∏–æ–¥ —Ä–∞–±–æ—Ç—ã:</b> 20 –∏—é–Ω—è - 15 –∞–≤–≥—É—Å—Ç–∞ 2025 –≥.\n"
        "üçΩ <b>–ü–µ—Ä–µ—Ä—ã–≤:</b> –±–µ–∑ –ø–µ—Ä–µ—Ä—ã–≤–∞ –Ω–∞ –æ–±–µ–¥",

    "–ö–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω—É–∂–Ω—ã?":
        "üìã <b>–û—Å–Ω–æ–≤–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:</b>\n"
        "- –ö–æ–ø–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞\n"
        "- –û—Ä–∏–≥–∏–Ω–∞–ª –∏ –∫–æ–ø–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –æ–± –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–∏\n"
        "- 6 —Ñ–æ—Ç–æ 3—Ö4\n\n"
        "‚ö†Ô∏è <b>–ü–æ—Å–ª–µ –∑–∞—á–∏—Å–ª–µ–Ω–∏—è:</b>\n"
        "- –ú–µ–¥—Å–ø—Ä–∞–≤–∫–∞ –ø–æ —Ñ–æ—Ä–º–µ 086/—É\n"
        "- –ö–æ–ø–∏—è –°–ù–ò–õ–°\n"
        "- –ö–æ–ø–∏—è –ò–ù–ù\n"
        "- –ö–æ–ø–∏—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –ø–æ–ª–∏—Å–∞",

    "–ü—Ä–æ—Ö–æ–¥–Ω—ã–µ –±–∞–ª–ª—ã":
        "üéØ <b>–ö–æ–Ω–∫—É—Ä—Å –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è –ø–æ —Å—Ä–µ–¥–Ω–µ–º—É –±–∞–ª–ª—É –∞—Ç—Ç–µ—Å—Ç–∞—Ç–∞</b>\n"
        "‚ÑπÔ∏è –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω\n\n"
        "<b>–ë–æ–Ω—É—Å–Ω—ã–µ –±–∞–ª–ª—ã –∑–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</b>\n"
        "ü•á –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –æ–ª–∏–º–ø–∏–∞–¥: +2 –±–∞–ª–ª–∞\n"
        "ü•à –ü—Ä–∏–∑–µ—Ä—ã –∫–æ–Ω–∫—É—Ä—Å–æ–≤: +1.5 –±–∞–ª–ª–∞",

    "–ï—Å—Ç—å –ª–∏ –æ–±—â–µ–∂–∏—Ç–∏–µ?":
        "üö´ <b>–°–≤–æ–±–æ–¥–Ω—ã—Ö –º–µ—Å—Ç –≤ –æ–±—â–µ–∂–∏—Ç–∏–∏ –∫–æ–ª–ª–µ–¥–∂–∞ –Ω–µ—Ç</b>"
}


# –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ FAQ
def build_faq_keyboard():
    builder = ReplyKeyboardBuilder()
    for question in formatted_faq_responses.keys():
        builder.add(types.KeyboardButton(text=question))
    builder.add(types.KeyboardButton(text="–ó–∞–¥–∞—Ç—å —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å"))
    builder.adjust(2)
    return builder.as_markup(resize_keyboard=True)


# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ –¥–∏–∞–ª–æ–≥–∞ —Å –ò–ò
def build_dialog_keyboard():
    builder = ReplyKeyboardBuilder()
    for question in formatted_faq_responses.keys():
        builder.add(types.KeyboardButton(text=question))
    builder.add(types.KeyboardButton(text="‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–∏–∞–ª–æ–≥"))
    builder.adjust(2)
    return builder.as_markup(resize_keyboard=True)


# –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ò–ò
def get_ai_context():
    context = "–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏ –ù–æ–≥–∏–Ω—Å–∫–æ–≥–æ –∫–æ–ª–ª–µ–¥–∂–∞. "
    context += "–ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–¥—É—é—â—É—é –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤:\n\n"

    for title, content in faq_responses.items():
        context += f"## {title} ##\n{content}\n\n"

    context += (
        "–ü—Ä–∞–≤–∏–ª–∞ –æ—Ç–≤–µ—Ç–æ–≤:\n"
        "1. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π, –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, —Å—Ä–æ–∫–æ–≤ - –∏—Å–ø–æ–ª—å–∑—É–π –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n"
        "2. –ù–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –æ—Ç–≤–µ—á–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω–æ\n"
        "3. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞, –ø—Ä–µ–¥–ª–æ–∂–∏ —É—Ç–æ—á–Ω–∏—Ç—å –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É\n"
        "4. –û—Ç–≤–µ—á–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ\n"
        "5. –§–æ—Ä–º–∞—Ç–∏—Ä—É–π –æ—Ç–≤–µ—Ç: —Å–Ω–∞—á–∞–ª–∞ —Ç–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç, –∑–∞—Ç–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ—è—Å–Ω–µ–Ω–∏—è"
    )

    return context


# –û—á–∏—â–∞–µ–º HTML –¥–ª—è –ò–ò
def clean_html(text):
    return re.sub('<[^<]+?>', '', text)


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
@dp.message(Command("start"))
async def send_welcome(message: Message):
    user_id = message.from_user.id
    user_states[user_id] = "menu"
    conversation_history[user_id] = []

    keyboard = build_faq_keyboard()
    await message.answer(
        "üéì <b>–ü—Ä–∏–≤–µ—Ç! –Ø —á–∞—Ç-–±–æ—Ç –ù–æ–≥–∏–Ω—Å–∫–æ–≥–æ –∫–æ–ª–ª–µ–¥–∂–∞</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π –≤–∞—Å –≤–æ–ø—Ä–æ—Å –∏–∑ –º–µ–Ω—é –Ω–∏–∂–µ:",
        reply_markup=keyboard
    )


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ FAQ
@dp.message(lambda message: message.text in formatted_faq_responses)
async def handle_faq(message: Message):
    user_id = message.from_user.id
    response = formatted_faq_responses[message.text]

    # –ï—Å–ª–∏ –≤ —Ä–µ–∂–∏–º–µ –¥–∏–∞–ª–æ–≥–∞ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å –¥–∏–∞–ª–æ–≥–æ–≤–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
    if user_states.get(user_id) == "ai_dialog":
        await message.answer(
            f"üìã <b>–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</b>\n\n{response}",
            reply_markup=build_dialog_keyboard()
        )
    else:
        await message.answer(response)


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ó–∞–¥–∞—Ç—å —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å"
@dp.message(lambda message: message.text == "–ó–∞–¥–∞—Ç—å —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å")
async def handle_custom_question(message: Message):
    user_id = message.from_user.id
    user_states[user_id] = "ai_dialog"

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
    conversation_history[user_id] = [
        {"role": "system", "content": get_ai_context()}
    ]

    await message.answer(
        "üí¨ <b>–†–µ–∂–∏–º –¥–∏–∞–ª–æ–≥–∞ —Å –ø–æ–º–æ—â–Ω–∏–∫–æ–º</b>\n\n"
        "–Ø –∑–Ω–∞—é –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –∏ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã.\n"
        "–ò—Å–ø–æ–ª—å–∑—É—é –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–ª–ª–µ–¥–∂–∞ –¥–ª—è —Ç–æ—á–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤.\n\n"
        "–í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –≤—ã–±–∏—Ä–∞—Ç—å —Ç–µ–º—ã –∏–∑ –º–µ–Ω—é –Ω–∏–∂–µ ‚¨áÔ∏è",
        reply_markup=build_dialog_keyboard()
    )


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
@dp.message(lambda message: message.text == "‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–∏–∞–ª–æ–≥")
async def end_dialog(message: Message):
    user_id = message.from_user.id
    user_states[user_id] = "menu"

    keyboard = build_faq_keyboard()
    await message.answer(
        "‚úÖ –î–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à–µ–Ω. –í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.",
        reply_markup=keyboard
    )


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ —Ä–µ–∂–∏–º–µ –¥–∏–∞–ª–æ–≥–∞
@dp.message(lambda message: user_states.get(message.from_user.id) == "ai_dialog")
async def handle_ai_question(message: Message):
    user_id = message.from_user.id

    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
    if message.text == "‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–∏–∞–ª–æ–≥":
        return

    # –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ FAQ-–∫–Ω–æ–ø–∫–∞ - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ
    if message.text in formatted_faq_responses:
        await handle_faq(message)
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ
    if message.content_type != ContentType.TEXT:
        await message.answer(
            "‚ùå –Ø –ø–æ–Ω–∏–º–∞—é —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å —Ç–µ–∫—Å—Ç–æ–º.",
            reply_markup=build_dialog_keyboard()
        )
        return

    # –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
    conversation_history[user_id].append({
        "role": "user",
        "content": message.text
    })

    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ OpenRouter API
        completion = api.chat.completions.create(
            model="deepseek/deepseek-r1-0528-qwen3-8b:free",
            messages=conversation_history[user_id],
            temperature=0.7,
            max_tokens=1024,
        )

        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç API
        response = completion.choices[0].message.content.strip()

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
        if not response:
            raise ValueError("API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç")

        # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
        conversation_history[user_id].append({
            "role": "assistant",
            "content": response
        })

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        await message.answer(response, reply_markup=build_dialog_keyboard())

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–æ–ø—Ä–æ—Å–∞ {user_id}: {e}")

        # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –æ—Ç–≤–µ—Ç –≤ FAQ
        found = False
        for keyword, answer in formatted_faq_responses.items():
            if keyword.lower() in message.text.lower():
                await message.answer(
                    f"üîç –ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∞–π–¥–µ–Ω–æ:\n\n{answer}",
                    reply_markup=build_dialog_keyboard()
                )
                found = True
                break

        if not found:
            await message.answer(
                "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å —Ç–µ–º—É –∏–∑ –º–µ–Ω—é.",
                reply_markup=build_dialog_keyboard()
            )


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
@dp.message()
async def handle_other_messages(message: Message):
    user_id = message.from_user.id
    current_state = user_states.get(user_id)

    # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ
    if message.content_type != ContentType.TEXT:
        reply_markup = build_faq_keyboard() if current_state == "menu" else build_dialog_keyboard()
        await message.answer(
            "‚ùå –Ø –ø–æ–Ω–∏–º–∞—é —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã.",
            reply_markup=reply_markup
        )
        return

    # –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ –±—ã–ª–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –¥—Ä—É–≥–∏–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏
    if current_state == "menu":
        # –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –æ—Ç–≤–µ—Ç –≤ FAQ
        found = False
        for keyword, answer in formatted_faq_responses.items():
            if keyword.lower() in message.text.lower():
                await message.answer(answer, reply_markup=build_faq_keyboard())
                found = True
                break

        if not found:
            keyboard = build_faq_keyboard()
            await message.answer(
                "ü§î –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–∑ –º–µ–Ω—é –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ '–ó–∞–¥–∞—Ç—å —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å'",
                reply_markup=keyboard
            )
    elif current_state == "ai_dialog":
        await handle_ai_question(message)
    else:
        user_states[user_id] = "menu"
        keyboard = build_faq_keyboard()
        await message.answer(
            "üîÑ –í–æ–∑–≤—Ä–∞—â–∞—é –≤–∞—Å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            reply_markup=keyboard
        )


# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
async def main():
    await dp.start_polling(bot, skip_updates=True)


if __name__ == '__main__':
    asyncio.run(main())